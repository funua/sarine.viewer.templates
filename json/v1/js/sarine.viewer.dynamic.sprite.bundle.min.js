/*! sarine.viewer.dynamic.sprite - v0.0.1 -  2015-02-09 */
(function(){var t,n,r={}.hasOwnProperty,i=function(n,t){function u(){this.constructor=n}for(var i in t)r.call(t,i)&&(n[i]=t[i]);return u.prototype=t.prototype,n.prototype=new u,n.__super__=t.prototype,n};n=function(){function n(t){this.first_init_defer=$.Deferred();this.full_init_defer=$.Deferred();this.src=t.src;this.element=t.element;this.autoPlay=t.autoPlay;this.id=this.element[0].id;this.element=this.convertElement();Object.getOwnPropertyNames(n.prototype).forEach(function(n){if(this[n].name==="Error")return console.error(this.id,n,"Must be implement",this)},this);this.element.data("class",this);this.element.on("play",function(n){return $(n.target).data("class").play.apply($(n.target).data("class"),[!0])});this.element.on("stop",function(n){return $(n.target).data("class").stop.apply($(n.target).data("class"),[!0])});this.element.on("cancel",function(n){return $(n.target).data("class").cancel().apply($(n.target).data("class"),[!0])})}var i,t;return t=ResourceManager.getInstance(),i=function(){return console.error(this.id,"must be implement")},n.prototype.first_init=Error,n.prototype.full_init=Error,n.prototype.play=Error,n.prototype.stop=Error,n.prototype.convertElement=Error,n.prototype.cancel=function(){return t.cancel(this)},n.prototype.loadImage=function(n){return t.loadImage.apply(this,[n])},n.prototype.setTimeout=function(){return t.setTimeout.apply(this,[this.delay])},n}();console.log("");this.Viewer=n;n.Dynamic=function(t){function r(t){r.__super__.constructor.call(this,t);this.delay=50;Object.getOwnPropertyNames(n.Dynamic.prototype).forEach(function(n){if(this[n].name==="Error")return console.error(this.id,n,"Must be implement",this)},this)}return i(r,t),r.playing=!1,r.prototype.nextImage=Error,r.prototype.play=function(n){var t;return n&&(this.playing=!0),this.nextImage.apply(this),this.playing?(t=this,this.setTimeout(this.delay).then(t.play)):void 0},r.prototype.stop=function(){return this.playing=!1},r}(n);t=function(n){function t(n){t.__super__.constructor.call(this,n);this.jsonFileName=n.jsonFileName;this.firstImagePath=n.firstImagePath;this.spritesPath=n.spritesPath;this.oneSprite=n.oneSprite;this.metadata=void 0;this.sprites=[];this.currentSprite=0;this.playing=!1;this.delta=1;this.imageIndex=-1;this.imagesDownload=0;this.imagegap=0;this.playOrder={}}var r;return i(t,n),r=function(){function n(n,t){this.column=n.width/t;this.rows=n.height/t;this.image=n;this.totalImage=this.column*this.rows}return n}(),t.prototype.convertElement=function(){return this.canvas=$("<canvas>"),this.ctx=this.canvas[0].getContext("2d"),this.element.append(this.canvas)},t.prototype.first_init=function(){var t,i,n;return t=this.first_init_defer,i={},t.notify(this.id,"load_json","start"),n=this,$.getJSON(this.src+this.jsonFileName,function(i){return n.metadata=i,t.notify(n.id+" : load Json"),n.metadata=i,n.canvas.attr({width:i.ImageSize,height:i.ImageSize}).parent().css("background","#"+i.background),n.delay=1e3/i.FPS,n.playing?n.play():void 0}).then(function(){return t.notify(n.id+" : start load first image"),n.loadImage(n.src+n.firstImagePath).then(function(i){return t.notify(n.id+" : finish load first image"),n.ctx.drawImage(i,0,0,n.metadata.ImageSize,n.metadata.ImageSize),n.imageIndex=0,t.resolve()})}),t},t.prototype.full_init=function(){var n,t;return n=this.full_init_defer,n.notify(this.id+" : start load first image"),t=this,this.downloadSprite(n).then(function(){return t.autoPlay&&t.play(!0),!0}),n},t.prototype.downloadSprite=function(n){var t;return t=this,this.loadImage(this.src+this.spritesPath+(this.oneSprite?"":this.sprites.length)+".jpg").then(function(i){var u;return u=new r(i,t.metadata.ImageSize),t.imagesDownload+=u.column*u.rows,t.sprites.push(u),t.imagesDownload>=t.metadata.TotalImageCount?n.resolve():t.downloadSprite(n),!0})},t.prototype.autoPlayFunc=function(){},t.prototype.nextImage=function(){var r,i,t,n,u;if(this.metadata&&this.sprites.length>0)return(this.imageIndex+this.delta===this.metadata.TotalImageCount||this.imageIndex+this.delta===this.imagesDownload)&&(this.delta=-1),this.imageIndex+this.delta===-1&&(this.delta=1),this.imageIndex+=this.delta,n=this.sprites[this.currentSprite],(this.imageIndex-this.imagegap)%n.totalImage==0&&this.imageIndex>0&&(this.delta===1?n=this.sprites[++this.currentSprite]:this.delta===-1&&(n=this.sprites[--this.currentSprite]),this.imagegap=this.imageIndex),i=this.imageIndex-this.imagegap+(this.delta===-1?this.sprites[this.currentSprite].totalImage:0),r=parseInt(-1*parseInt(i%n.column)*this.metadata.ImageSize),u=parseInt(-1*parseInt(i/n.rows)*this.metadata.ImageSize),this.playOrder[this.imageIndex]||(this.playOrder[this.imageIndex]={spriteNumber:this.currentSprite,col:r,row:u}),t=this.playOrder[this.imageIndex],this.ctx.drawImage(this.sprites[t.spriteNumber].image,t.col,t.row)},t}(n.Dynamic);this.Sprite=t}).call(this);
//# sourceMappingURL=sarine.viewer.dynamic.sprite.min.js.map
